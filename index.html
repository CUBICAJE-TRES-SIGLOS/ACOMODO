<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Sistema de cubicaje - Comercializadora de Llantas Tres Siglos</title>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0; padding: 0;
        background: url('https://www.firestone.com.mx/content/dam/consumer/fst/la/mx/tips/comprar-llantas/Llantas_Nuevas_big.jpg') no-repeat center fixed;
        background-size: cover;
    }
    header {
        display: flex;
        align-items: center;
        background: #b0dab9bb;
        color: #24412b;
        padding: 12px 24px;
    }
    header img {
        height: 44px;
        margin-right: 12px;
        opacity: 0.7;
    }
    nav {
        display: flex;
        background: #b0dab9e6;
    }
    nav button {
        flex: 1;
        padding: 12px 0;
        color: #24412b;
        background: transparent;
        border: none;
        cursor: pointer;
        font-weight: bold;
        letter-spacing: 1px;
        transition: background 0.3s;
    }
    nav button:hover, nav button.active {
        background: #d9efe0;
    }
    section {
        background: rgba(255,255,255,0.88);
        border-radius: 16px;
        margin: 32px auto 16px auto;
        max-width: 1200px;
        box-shadow: 0 8px 32px rgba(72,144,81,0.13);
        padding: 28px 22px;
    }
    .tabcontent {
        display: none;
        background: transparent;
    }
    .tabcontent.active {
        display: block;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 12px;
        background: white;
        border-radius: 8px;
        overflow: hidden;
    }
    th, td {
        border: 1px solid #e2e2e2;
        padding: 8px 12px;
        text-align: center;
    }
    th {
        background: #f7fcf8;
    }
    .search-bar {
        margin-top: 8px;
        margin-bottom: 12px;
        padding: 7px;
        font-size: 17px;
        border-radius: 5px;
        border: 1px solid #cde5d4;
        flex-grow: 1;
    }
    button.primary {
        background: #489051;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        padding: 8px 18px;
        font-weight: bold;
        margin-top: 0;
        transition: background 0.3s;
        white-space: nowrap;
    }
    button.primary:hover {
        background: #75c286;
    }
    .highlight-yellow {
        background-color: #fffa8b;
        transition: background-color 1s;
    }
    .graph-container {
        width: 45%;
        background: #f5fdf7;
        padding: 16px;
        border-radius: 14px;
        border: 1px solid #e2e2e2;
        margin: 8px 5px 16px 0;
        display: inline-block;
        vertical-align: top;
        box-shadow: 0 3px 12px #d6eedd83;
    }
    @media (max-width: 900px){
        .graph-container{ width: 95%; margin:auto; margin-bottom:16px;}
    }
    .search-and-button {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
        max-width: 700px;
        flex-wrap: wrap;
    }

    /* Modal base styles */
    .modal {
        display: none; 
        position: fixed; 
        z-index: 1000;
        left: 0; top: 0;
        width: 100%; height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4); /* fondo semitransparente */
    }
    .modal-content {
        background-color: #fefefe;
        margin: 5% auto; /* centrado vertical */
        padding: 20px;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        position: relative;
        box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }
    .close {
        position: absolute;
        right: 20px;
        top: 10px;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        color: #555;
        user-select: none;
    }

    form.add-form label {
        display: block;
        margin: 12px 0 5px 0;
        font-weight: bold;
        color: #35672b;
    }
    form.add-form input[type=text], form.add-form input[type=number] {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid #a3d087;
        border-radius: 6px;
        box-sizing: border-box;
        margin-bottom: 12px;
        font-size: 16px;
        color: #24412b;
    }
    form.add-form button.submit-btn {
        margin-top: 10px;
        padding: 10px 20px;
        background: #489051;
        color: white;
        border: none;
        font-weight: bold;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.3s;
        width: 100%;
        font-size: 17px;
    }
    form.add-form button.submit-btn:hover {
        background: #75c286;
    }
    .msg {
        margin: 8px 0 0 0;
        font-size: 15px;
        min-height: 20px;
    }
    .msg.success {
        color: green;
    }
    .msg.error {
        color: red;
    }
</style>
</head>
<body>

<header>
    <img src="https://cdn.prod.website-files.com/62b4e3084bb69b3cbd747e80/62b4e344650db7626d857053_TS_ORGINAL_LOGO.png" alt="Logo Tres Siglos" />
    <h1>Sistema de cubicaje - Comercializadora de Llantas Tres Siglos</h1>
</header>

<nav>
    <button class="tablink active" data-tab="inventario">Inventario</button>
    <button class="tablink" data-tab="flota">Flota</button>
    <button class="tablink" data-tab="pedidos">Pedidos</button>
    <button class="tablink" data-tab="pedidos-confirmados">Pedidos Confirmados</button>
</nav>

<section>

    <!-- Inventario -->
    <div id="inventario" class="tabcontent active">
        <div class="search-and-button">
            <input type="text" id="searchInventario" class="search-bar" placeholder="Buscar por ID Llanta..." oninput="searchInventario()" />
            <button class="primary" onclick="openModal('modalInventario')">Agregar Llanta</button>
            <button class="primary" onclick="fetchInventario()">Actualizar inventario</button>
        </div>

        <table id="tablaInventario">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Descripción</th>
                    <th>Peso (kg)</th>
                    <th>Volumen (m³)</th>
                    <th>Valor ($)</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Modal Inventario -->
    <div id="modalInventario" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('modalInventario')">&times;</span>
            <form id="formAgregarLlanta" class="add-form" onsubmit="event.preventDefault(); agregarNuevaLlanta();">
                <h3>Agregar Nueva Llanta</h3>
                <label for="agregarId">ID (dejar vacío para autogenerar)</label>
                <input type="text" id="agregarId" placeholder="Ejemplo: 1001 o dejar vacío para auto" />

                <label for="agregarDescripcion">Descripción</label>
                <input type="text" id="agregarDescripcion" placeholder="Descripción de la llanta" required />

                <label for="agregarPeso">Peso (kg)</label>
                <input type="number" id="agregarPeso" step="0.01" min="0" placeholder="Ejemplo: 12.5" required />

                <label for="agregarVolumen">Volumen unitario (m³)</label>
                <input type="number" id="agregarVolumen" step="0.0001" min="0" placeholder="Ejemplo: 0.0035" required />

                <label for="agregarValor">Valor unitario ($)</label>
                <input type="number" id="agregarValor" step="0.01" min="0" placeholder="Ejemplo: 1500.00" required />

                <button type="submit" class="submit-btn">Agregar Llanta</button>
                <div id="msgInventario" class="msg"></div>
            </form>
        </div>
    </div>

    <!-- Flota -->
    <div id="flota" class="tabcontent">
        <div class="search-and-button">
            <input type="text" id="searchFlota" class="search-bar" placeholder="Buscar por Número Económico..." oninput="searchFlota()" />
            <button class="primary" onclick="openModal('modalFlota')">Agregar Camión</button>
            <button class="primary" onclick="fetchFlota()">Actualizar flota</button>
        </div>

        <table id="tablaFlota">
            <thead>
                <tr>
                    <th>Económico</th>
                    <th>Unidad</th>
                    <th>Asignado</th>
                    <th>Modelo</th>
                    <th>Placas</th>
                    <th>Ubicación</th>
                    <th>Carga (kg)</th>
                    <th>Volumen (m³)</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Modal Flota -->
    <div id="modalFlota" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('modalFlota')">&times;</span>
            <form id="formAgregarCamion" class="add-form" onsubmit="event.preventDefault(); agregarNuevoCamion();">
                <h3>Agregar Nuevo Camión</h3>

                <label for="agregarEconomico">Número Económico (dejar vacío para autogenerar)</label>
                <input type="text" id="agregarEconomico" placeholder="Ejemplo: 101 o dejar vacío para auto" />

                <label for="agregarUnidad">Unidad</label>
                <input type="text" id="agregarUnidad" placeholder="Unidad/vehículo" required />

                <label for="agregarAsignado">Asignado</label>
                <input type="text" id="agregarAsignado" placeholder="Nombre responsable" required />

                <label for="agregarModelo">Modelo</label>
                <input type="text" id="agregarModelo" placeholder="Modelo del camión" required />

                <label for="agregarPlacas">Placas</label>
                <input type="text" id="agregarPlacas" placeholder="Placas del camión" required />

                <label for="agregarUbicacion">Ubicación</label>
                <input type="text" id="agregarUbicacion" placeholder="Ubicación del camión" required />

                <label for="agregarCarga">Capacidad de Carga (kg)</label>
                <input type="number" id="agregarCarga" step="0.01" min="0" placeholder="Ejemplo: 15000" required />

                <label for="agregarVolumenCamion">Capacidad de Volumen (m³)</label>
                <input type="number" id="agregarVolumenCamion" step="0.0001" min="0" placeholder="Ejemplo: 40.5" required />

                <button type="submit" class="submit-btn">Agregar Camión</button>
                <div id="msgFlota" class="msg"></div>
            </form>
        </div>
    </div>

    <!-- Pedidos -->
    <div id="pedidos" class="tabcontent" style="max-width: 1000px;">
        <div>
            <label for="inputPedidoNumEconomico">Número Económico Camión:</label>
            <input type="text" id="inputPedidoNumEconomico" oninput="llenarDatosCamionPedido()" placeholder="Ingrese número económico" />
        </div>
        <div id="datosCamionPedido" style="margin-top:10px; font-weight:bold; min-height: 50px;"></div>

        <div style="margin-top: 20px;">
            <div class="graph-container">
                <canvas id="graphVolumen" width="400" height="250"></canvas>
                <p style="text-align:center">Volumen Usado</p>
            </div>
            <div class="graph-container">
                <canvas id="graphCarga" width="400" height="250"></canvas>
                <p style="text-align:center">Carga Usada</p>
            </div>
        </div>

        <h3>Agregar Llanta al Pedido</h3>
        <table id="tablaPedidoAgregar" style="max-width:700px;">
            <thead>
                <tr>
                    <th>Código Llanta</th>
                    <th>Descripción</th>
                    <th>Cantidad</th>
                    <th>Peso</th>
                    <th>Volumen</th>
                    <th>Valor Unitario ($)</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><input type="text" id="pedidoCodigoLlanta" oninput="autoCompletarLlantaPedido()" /></td>
                    <td id="pedidoDescripcionLlanta"></td>
                    <td><input type="number" id="pedidoCantidadLlanta" value="1" min="1" oninput="calcularTotalesPedido()" /></td>
                    <td id="pedidoPesoLlanta">0</td>
                    <td id="pedidoVolumenLlanta">0</td>
                    <td id="pedidoValorUnitarioLlanta">0</td>
                    <td><button class="primary" onclick="agregarPedido()">Agregar</button></td>
                </tr>
            </tbody>
        </table>

        <h3>Pedidos actuales del camión</h3>
        <table id="tablaPedidosActuales" style="max-width:700px;">
            <thead>
                <tr>
                    <th>Código</th>
                    <th>Descripción</th>
                    <th>Cantidad</th>
                    <th>Volumen Total</th>
                    <th>Peso Total</th>
                    <th>Valor Total ($)</th>
                    <th>Quitar</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div style="margin-top: 10px; font-weight: bold;">
            <span id="totalesPedido"></span>
        </div>

        <button class="primary" onclick="aceptarPedido()" style="margin-top: 10px;">Aceptar Pedido</button>
    </div>

    <!-- Pedidos Confirmados -->
    <div id="pedidos-confirmados" class="tabcontent" style="max-width: 900px;">
        <h3>Pedidos Confirmados</h3>
        <table id="tablaPedidosConfirmados">
            <thead>
                <tr>
                    <th>Camión</th>
                    <th>Llantas</th>
                    <th>Volumen</th>
                    <th>Peso</th>
                    <th>Valor ($)</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Variables de datos
    let inventario = [];
    let flota = [];
    let pedidosConfirmados = [];
    let pedidosEnCurso = [];
    let pedidoCamion = null;

    // Abrir y cerrar modales
    function openModal(id) {
        document.getElementById(id).style.display = 'block';
    }
    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
    }
    // Cerrar modal si el usuario hace click fuera del contenido
    window.onclick = function(event) {
        const modales = ['modalInventario','modalFlota'];
        modales.forEach(id => {
            const modal = document.getElementById(id);
            if(event.target === modal) {
                modal.style.display = 'none';
            }
        });
    };

    // ---------- Funciones para cargar datos ---------
    async function fetchInventario() {
        try {
            const res = await fetch('https://sheetdb.io/api/v1/r2p3mz6asrkyg');
            if (!res.ok) throw new Error('Error al cargar inventario');
            inventario = await res.json();
            renderInventario();
        } catch (e) {
            alert('No se pudo cargar el inventario: ' + e.message);
        }
    }
    async function fetchFlota() {
        try {
            const res = await fetch('https://sheetdb.io/api/v1/r2p3mz6asrkyg?sheet=flota');
            if (!res.ok) throw new Error('Error al cargar flota');
            flota = await res.json();
            renderFlota();
        } catch (e) {
            alert('No se pudo cargar la flota: ' + e.message);
        }
    }
    fetchInventario();
    fetchFlota();

    // ----- Cambiar pestañas -----
    const tablinks = document.querySelectorAll('.tablink');
    const tabcontents = document.querySelectorAll('.tabcontent');
    tablinks.forEach(button => {
        button.addEventListener('click', () => {
            tablinks.forEach(btn => btn.classList.remove('active'));
            tabcontents.forEach(tc => tc.classList.remove('active'));
            button.classList.add('active');
            document.getElementById(button.dataset.tab).classList.add('active');
            if (button.dataset.tab === 'inventario') renderInventario();
            if (button.dataset.tab === 'flota') renderFlota();
            if (button.dataset.tab === 'pedidos') resetPedidoInputs();
            if (button.dataset.tab === 'pedidos-confirmados') renderPedidosConfirmados();
        });
    });

    // ---------- Renderizar Inventario ----------
    function renderInventario() {
        const tbody = document.querySelector('#tablaInventario tbody');
        tbody.innerHTML = '';
        inventario.forEach(llanta => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${llanta.id}</td>
                <td>${llanta.descripcion}</td>
                <td>${(+llanta.peso).toFixed(2)}</td>
                <td>${(+llanta.volumen).toFixed(4)}</td>
                <td>$${(+llanta.valor).toFixed(2)}</td>`;
            tbody.appendChild(tr);
        });
        highlightSearch('inventario', document.getElementById('searchInventario').value);
    }
    // Buscar ID inventario
    function searchInventario() {
        const filter = document.getElementById('searchInventario').value.toLowerCase();
        const tbody = document.querySelector('#tablaInventario tbody');
        for (let row of tbody.rows) {
            const idCell = row.cells[0].textContent.toLowerCase();
            row.style.display = idCell.includes(filter) ? '' : 'none';
            if (idCell.includes(filter) && filter) {
                row.classList.add('highlight-yellow');
                setTimeout(() => row.classList.remove('highlight-yellow'), 1100);
            }
        }
    }
    function highlightSearch(tab, valor) {
        if (!valor) return;
        let rows = document.querySelector(`#tabla${tab.charAt(0).toUpperCase() + tab.slice(1)} tbody`).rows;
        [...rows].forEach(row => {
            if (row.cells[0].textContent.toLowerCase().includes(valor.toLowerCase())) {
                row.classList.add('highlight-yellow');
                row.scrollIntoView({ behavior: "smooth", block: "center" });
                setTimeout(() => row.classList.remove('highlight-yellow'), 900);
            }
        });
    }

    // ---------- Agregar nueva llanta a SheetDB ----------
    async function agregarNuevaLlanta() {
        const idInput = document.getElementById('agregarId').value.trim();
        const descripcion = document.getElementById('agregarDescripcion').value.trim();
        const peso = parseFloat(document.getElementById('agregarPeso').value);
        const volumen = parseFloat(document.getElementById('agregarVolumen').value);
        const valor = parseFloat(document.getElementById('agregarValor').value);
        const msgDiv = document.getElementById('msgInventario');
        msgDiv.textContent = '';
        msgDiv.className = 'msg';

        if (!descripcion || isNaN(peso) || isNaN(volumen) || isNaN(valor)) {
            msgDiv.textContent = 'Por favor completa todos los campos correctamente.';
            msgDiv.classList.add('error');
            return;
        }

        let id = idInput || generarNuevoIdInventario();

        if (inventario.some(ll => ll.id === id)) {
            msgDiv.textContent = 'El ID ya existe. Por favor usa otro.';
            msgDiv.classList.add('error');
            return;
        }

        const nuevoDato = { id, descripcion, peso, volumen, valor };

        try {
            const res = await fetch('https://sheetdb.io/api/v1/r2p3mz6asrkyg', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: nuevoDato })
            });
            if (!res.ok) throw new Error('Error al agregar llanta');
            msgDiv.textContent = 'Llanta agregada correctamente!';
            msgDiv.classList.add('success');
            limpiarFormularioInventario();
            await fetchInventario();
            closeModal('modalInventario');
        } catch (e) {
            msgDiv.textContent = 'Error: ' + e.message;
            msgDiv.classList.add('error');
        }
    }
    function generarNuevoIdInventario() {
        if (!inventario.length) return "1";
        let maxId = inventario.reduce((max, ll) => {
            let n = parseInt(ll.id);
            return n > max ? n : max;
        }, 0);
        return String(maxId + 1);
    }
    function limpiarFormularioInventario() {
        document.getElementById('agregarId').value = '';
        document.getElementById('agregarDescripcion').value = '';
        document.getElementById('agregarPeso').value = '';
        document.getElementById('agregarVolumen').value = '';
        document.getElementById('agregarValor').value = '';
    }

    // ---------- Renderizar Flota ----------
  function renderFlota() {
    const tbody = document.querySelector('#tablaFlota tbody');
    tbody.innerHTML = '';
    flota.forEach(camion => {
        const cargaNum = parseFloat(camion.carga);
        const volumenNum = parseFloat(camion.volumen);
        const cargaMostrar = isNaN(cargaNum) ? '-' : cargaNum.toFixed(2);
        const volumenMostrar = isNaN(volumenNum) ? '-' : volumenNum.toFixed(4);
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${camion.economico || '-'}</td>
            <td>${camion.unidad || '-'}</td>
            <td>${camion.encargado || '-'}</td>
            <td>${camion.modelo || '-'}</td>
            <td>${camion.placas || '-'}</td>
            <td>${camion.ubicacion || '-'}</td>
            <td>${cargaMostrar}</td>
            <td>${volumenMostrar}</td>`;
        tbody.appendChild(tr);
    });
    highlightSearch('flota', document.getElementById('searchFlota').value);
}
    function searchFlota() {
        const filter = document.getElementById('searchFlota').value.toLowerCase();
        const tbody = document.querySelector('#tablaFlota tbody');
        for (let row of tbody.rows) {
            const idCell = row.cells[0].textContent.toLowerCase();
            row.style.display = idCell.includes(filter) ? '' : 'none';
            if (idCell.includes(filter) && filter) {
                row.classList.add('highlight-yellow');
                setTimeout(() => row.classList.remove('highlight-yellow'), 1100);
            }
        }
    }

    // ---------- Agregar nuevo camión a SheetDB ----------
    async function agregarNuevoCamion() {
        const economicoInput = document.getElementById('agregarEconomico').value.trim();
        const unidad = document.getElementById('agregarUnidad').value.trim();
        const asignado = document.getElementById('agregarAsignado').value.trim();
        const modelo = document.getElementById('agregarModelo').value.trim();
        const placas = document.getElementById('agregarPlacas').value.trim();
        const ubicacion = document.getElementById('agregarUbicacion').value.trim();
        const carga = parseFloat(document.getElementById('agregarCarga').value);
        const volumen = parseFloat(document.getElementById('agregarVolumenCamion').value);
        const msgDiv = document.getElementById('msgFlota');
        msgDiv.textContent = '';
        msgDiv.className = 'msg';

        if (!unidad || !asignado || !modelo || !placas || !ubicacion || isNaN(carga) || isNaN(volumen)) {
            msgDiv.textContent = 'Por favor completa todos los campos correctamente.';
            msgDiv.classList.add('error');
            return;
        }

        let economico = economicoInput || generarNuevoEconomico();

        if (flota.some(cam => cam.economico === economico)) {
            msgDiv.textContent = 'El número económico ya existe. Por favor usa otro.';
            msgDiv.classList.add('error');
            return;
        }

        const nuevoDato = {
            economico,
            unidad,
            asignado,
            modelo,
            placas,
            ubicacion,
            carga,
            volumen
        };

        try {
            const res = await fetch('https://sheetdb.io/api/v1/r2p3mz6asrkyg?sheet=flota', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: nuevoDato })
            });
            if (!res.ok) throw new Error('Error al agregar camión');
            msgDiv.textContent = 'Camión agregado correctamente!';
            msgDiv.classList.add('success');
            limpiarFormularioFlota();
            await fetchFlota();
            closeModal('modalFlota');
        } catch (e) {
            msgDiv.textContent = 'Error: ' + e.message;
            msgDiv.classList.add('error');
        }
    }
    function generarNuevoEconomico() {
        if (!flota.length) return "1";
        let maxEco = flota.reduce((max, cam) => {
            let n = parseInt(cam.economico);
            return n > max ? n : max;
        }, 0);
        return String(maxEco + 1);
    }
    function limpiarFormularioFlota() {
        document.getElementById('agregarEconomico').value = '';
        document.getElementById('agregarUnidad').value = '';
        document.getElementById('agregarAsignado').value = '';
        document.getElementById('agregarModelo').value = '';
        document.getElementById('agregarPlacas').value = '';
        document.getElementById('agregarUbicacion').value = '';
        document.getElementById('agregarCarga').value = '';
        document.getElementById('agregarVolumenCamion').value = '';
    }

    // ---------- Pedidos (igual que antes) ----------
    function llenarDatosCamionPedido() {
        const numEco = document.getElementById('inputPedidoNumEconomico').value.trim();
        const div = document.getElementById('datosCamionPedido');
        pedidoCamion = flota.find(c => c.economico.toString() === numEco);
        if (pedidoCamion) {
            div.innerText = `Camión: ${pedidoCamion.unidad}, Asignado: ${pedidoCamion.asignado}, Modelo: ${pedidoCamion.modelo}, Capacidad carga: ${pedidoCamion.carga} kg, Cap. volumen: ${pedidoCamion.volumen} m³`;
            pedidosEnCurso = [];
            renderPedidosActuales();
            actualizarGraficas();
        } else {
            div.innerText = 'Camión no encontrado.';
            pedidosEnCurso = [];
            renderPedidosActuales();
            actualizarGraficas();
        }
    }
    function autoCompletarLlantaPedido() {
        const codigo = document.getElementById('pedidoCodigoLlanta').value.trim();
        const llanta = inventario.find(item => item.id.toString() === codigo);
        if (llanta) {
            document.getElementById('pedidoDescripcionLlanta').innerText = llanta.descripcion;
            document.getElementById('pedidoCantidadLlanta').value = 1;
            document.getElementById('pedidoPesoLlanta').innerText = (+llanta.peso).toFixed(2);
            document.getElementById('pedidoVolumenLlanta').innerText = (+llanta.volumen).toFixed(4);
            document.getElementById('pedidoValorUnitarioLlanta').innerText = (+llanta.valor).toFixed(2);
        } else {
            document.getElementById('pedidoDescripcionLlanta').innerText = '';
            document.getElementById('pedidoPesoLlanta').innerText = '0';
            document.getElementById('pedidoVolumenLlanta').innerText = '0';
            document.getElementById('pedidoValorUnitarioLlanta').innerText = '0';
        }
    }
    function calcularTotalesPedido() {
        const cantidad = Number(document.getElementById('pedidoCantidadLlanta').value);
        const codigo = document.getElementById('pedidoCodigoLlanta').value.trim();
        const llanta = inventario.find(item => item.id.toString() === codigo);
        if (llanta && cantidad > 0) {
            document.getElementById('pedidoPesoLlanta').innerText = (llanta.peso * cantidad).toFixed(2);
            document.getElementById('pedidoVolumenLlanta').innerText = (llanta.volumen * cantidad).toFixed(4);
            document.getElementById('pedidoValorUnitarioLlanta').innerText = (llanta.valor * cantidad).toFixed(2);
        }
    }
    function agregarPedido() {
        if (!pedidoCamion) {
            alert("Ingrese un número económico válido de camión primero.");
            return;
        }
        const codigo = document.getElementById('pedidoCodigoLlanta').value.trim();
        const cantidad = Number(document.getElementById('pedidoCantidadLlanta').value);
        if (cantidad <= 0) {
            alert("La cantidad debe ser mayor a 0.");
            return;
        }
        const llanta = inventario.find(item => item.id.toString() === codigo);
        if (!llanta) {
            alert("Llanta no encontrada en inventario.");
            return;
        }
        const pedidoExistente = pedidosEnCurso.find(p => p.id === llanta.id);
        if (pedidoExistente) {
            pedidoExistente.cantidad += cantidad;
            pedidoExistente.peso += (+llanta.peso * cantidad);
            pedidoExistente.volumen += (+llanta.volumen * cantidad);
            pedidoExistente.valor += (+llanta.valor * cantidad);
        } else {
            pedidosEnCurso.push({
                id: llanta.id,
                descripcion: llanta.descripcion,
                cantidad: cantidad,
                peso: (+llanta.peso) * cantidad,
                volumen: (+llanta.volumen) * cantidad,
                valor: (+llanta.valor) * cantidad
            });
        }
        renderPedidosActuales();
        actualizarGraficas();
        resetPedidoInputs();
    }
    function renderPedidosActuales() {
        const tbody = document.querySelector('#tablaPedidosActuales tbody');
        tbody.innerHTML = '';
        pedidosEnCurso.forEach((pedido, idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${pedido.id}</td>
                <td>${pedido.descripcion}</td>
                <td>${pedido.cantidad}</td>
                <td>${pedido.volumen.toFixed(4)}</td>
                <td>${pedido.peso.toFixed(2)}</td>
                <td>$${pedido.valor.toFixed(2)}</td>
                <td><button onclick="quitarPedido(${idx})">Quitar</button></td>
            `;
            tbody.appendChild(tr);
        });
        let totalCantidad = 0, totalVolumen = 0, totalPeso = 0, totalValor = 0;
        pedidosEnCurso.forEach(p => {
            totalCantidad += p.cantidad;
            totalVolumen += p.volumen;
            totalPeso += p.peso;
            totalValor += p.valor;
        });
        document.getElementById('totalesPedido').innerText = 
          `Total cantidad: ${totalCantidad} | Total volumen: ${totalVolumen.toFixed(4)} m³ | Total peso: ${totalPeso.toFixed(2)} kg | Total valor: $${totalValor.toFixed(2)}`;
        verificarCapacidad(totalVolumen, totalPeso);
    }
    function quitarPedido(idx) {
        pedidosEnCurso.splice(idx, 1);
        renderPedidosActuales();
        actualizarGraficas();
    }
    function resetPedidoInputs() {
        document.getElementById('pedidoCodigoLlanta').value = '';
        document.getElementById('pedidoDescripcionLlanta').innerText = '';
        document.getElementById('pedidoCantidadLlanta').value = 1;
        document.getElementById('pedidoPesoLlanta').innerText = '0';
        document.getElementById('pedidoVolumenLlanta').innerText = '0';
        document.getElementById('pedidoValorUnitarioLlanta').innerText = '0';
    }

    // ----- Gráficas -----
    const ctxVolumen = document.getElementById('graphVolumen').getContext('2d');
    const ctxCarga = document.getElementById('graphCarga').getContext('2d');
    let chartVolumen = new Chart(ctxVolumen, {
        type: 'doughnut',
        data: { labels: ['Usado', 'Disponible'],
            datasets: [{ data: [0, 100], backgroundColor: ['#75c286', '#f3f3f3'], borderWidth: 1 }]
        },
        options: { plugins: {legend: {display: true}}, cutout: '70%' }
    });
    let chartCarga = new Chart(ctxCarga, {
        type: 'doughnut',
        data: { labels: ['Usado', 'Disponible'],
            datasets: [{ data: [0, 100], backgroundColor: ['#7ad4a2', '#f3f3f3'], borderWidth: 1 }]
        },
        options: { plugins: {legend: {display: true}}, cutout: '70%' }
    });
    function actualizarGraficas() {
        if (!pedidoCamion) {
            chartVolumen.data.datasets[0].data = [0, 100];
            chartCarga.data.datasets[0].data = [0, 100];
        } else {
            let totalVolumen = pedidosEnCurso.reduce((acc, cur) => acc + cur.volumen, 0);
            let totalPeso = pedidosEnCurso.reduce((acc, cur) => acc + cur.peso, 0);
            let volTotal = +pedidoCamion.volumen;
            let pesoTotal = +pedidoCamion.carga;
            chartVolumen.data.datasets[0].data = [Math.min(totalVolumen, volTotal), Math.max(0, volTotal - totalVolumen)];
            chartCarga.data.datasets[0].data = [Math.min(totalPeso, pesoTotal), Math.max(0, pesoTotal - totalPeso)];
        }
        chartVolumen.update(); chartCarga.update();
    }
    function verificarCapacidad(volumen, peso) {
        if (!pedidoCamion) return;
        const capVol = +pedidoCamion.volumen;
        const capPes = +pedidoCamion.carga;
        const volumenPercent = (volumen / capVol) * 100,
            pesoPercent = (peso / capPes) * 100;
        if (volumenPercent > 80 || pesoPercent > 80) {
            if (confirm('El camión se está llenando (>80%), ¿desea completar con otro camión?')) {
                alert('Aquí puedes permitir solicitar otro camión para continuar cargando los pedidos.');
            }
        }
    }
    function aceptarPedido() {
        if (!pedidoCamion) { alert('Debe seleccionar un camión válido para aceptar el pedido.'); return; }
        if (pedidosEnCurso.length === 0) { alert('El pedido está vacío.'); return; }
        let totalVolumen = pedidosEnCurso.reduce((acc, cur) => acc + cur.volumen, 0);
        let totalPeso = pedidosEnCurso.reduce((acc, cur) => acc + cur.peso, 0);
        let totalValor = pedidosEnCurso.reduce((acc, cur) => acc + cur.valor, 0);
        pedidosConfirmados.push({
            camion: pedidoCamion.economico,
            llantas: pedidosEnCurso.map(p => p.id).join(', '),
            volumen: totalVolumen,
            peso: totalPeso,
            valor: totalValor
        });
        pedidosEnCurso = [];
        pedidoCamion = null;
        document.getElementById('datosCamionPedido').innerText = '';
        document.getElementById('inputPedidoNumEconomico').value = '';
        renderPedidosActuales();
        actualizarGraficas();
        alert('Pedido aceptado y movido a pedidos confirmados.');
        renderPedidosConfirmados();
    }
    // -- Lista de pedidos confirmados --
    function renderPedidosConfirmados() {
        const tbody = document.querySelector('#tablaPedidosConfirmados tbody');
        tbody.innerHTML = '';
        pedidosConfirmados.forEach((pedido, idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${pedido.camion}</td>
                <td>${pedido.llantas}</td>
                <td>${pedido.volumen.toFixed(4)}</td>
                <td>${pedido.peso.toFixed(2)}</td>
                <td>$${pedido.valor.toFixed(2)}</td>
                <td><button onclick="cancelarPedido(${idx})">Cancelar</button></td>`;
            tbody.appendChild(tr);
        });
    }
    function cancelarPedido(idx) {
        if (confirm('¿Seguro que desea cancelar este pedido?')) {
            pedidosConfirmados.splice(idx, 1);
            renderPedidosConfirmados();
        }
    }
</script>

</body>
</html>
