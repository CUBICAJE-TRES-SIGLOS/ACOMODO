<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sistema de cubicaje - Comercializadora de Llantas Tres Siglos</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0; padding: 0;
            background: url('https://llantas24.com/wp-content/uploads/2024/03/que-utilidad-tienen-las-llantas-de-un-carro.jpg') no-repeat center fixed;
            background-size: cover;
        }
        header {
            display: flex;
            align-items: center;
            background: #b0dab9bb;
            color: #24412b;
            padding: 12px 24px;
        }
        header img {
            height: 44px;
            margin-right: 12px;
            opacity: 0.7;
        }
        nav {
            display: flex;
            background: #b0dab9e6;
        }
        nav button {
            flex: 1;
            padding: 12px 0;
            color: #24412b;
            background: transparent;
            border: none;
            cursor: pointer;
            font-weight: bold;
            letter-spacing: 1px;
            transition: background 0.3s;
        }
        nav button:hover, nav button.active {
            background: #d9efe0;
        }
        section {
            background: rgba(255,255,255,0.88);
            border-radius: 16px;
            margin: 32px auto 16px auto;
            max-width: 1200px;
            box-shadow: 0 8px 32px rgba(72,144,81,0.13);
            padding: 28px 22px;
        }
        .tabcontent {
            display: none;
            background: transparent;
        }
        .tabcontent.active {
            display: block;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        th, td {
            border: 1px solid #e2e2e2;
            padding: 8px 12px;
            text-align: center;
        }
        th {
            background: #f7fcf8;
        }
        .search-bar {
            margin-top: 8px;
            margin-bottom: 12px;
            padding: 7px;
            font-size: 17px;
            border-radius: 5px;
            border: 1px solid #cde5d4;
            flex-grow: 1;
        }
        .form-inline {
            display: flex;
            gap: 10px;
            margin-top: 12px;
            flex-wrap: wrap;
        }
        .form-inline label {
            flex-basis: 150px;
            align-self: center;
        }
        .form-inline input {
            flex-grow: 1;
            padding: 6px;
        }
        button.primary {
            background: #489051;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            padding: 8px 18px;
            font-weight: bold;
            margin-top: 0;
            transition: background 0.3s;
            white-space: nowrap;
        }
        button.primary:hover {
            background: #75c286;
        }
        .highlight-yellow {
            background-color: #fffa8b;
            transition: background-color 1s;
        }
        .graph-container {
            width: 45%;
            background: #f5fdf7;
            padding: 16px;
            border-radius: 14px;
            border: 1px solid #e2e2e2;
            margin: 8px 5px 16px 0;
            display: inline-block;
            vertical-align: top;
            box-shadow: 0 3px 12px #d6eedd83;
        }
        @media (max-width: 900px){
            .graph-container{ width: 95%; margin:auto; margin-bottom:16px;}
        }
        /* Contenedor flex para barra búsqueda + botón para Inventario y Flota */
        .search-and-button {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            max-width: 600px;
        }
    </style>
</head>
<body>

<header>
    <img src="https://cdn.prod.website-files.com/62b4e3084bb69b3cbd747e80/62b4e344650db7626d857053_TS_ORGINAL_LOGO.png" alt="Logo Tres Siglos">
    <h1>Sistema de cubicaje - Comercializadora de Llantas Tres Siglos</h1>
</header>

<nav>
    <button class="tablink active" data-tab="inventario">Inventario</button>
    <button class="tablink" data-tab="flota">Flota</button>
    <button class="tablink" data-tab="pedidos">Pedidos</button>
    <button class="tablink" data-tab="pedidos-confirmados">Pedidos Confirmados</button>
</nav>

<section>
    <!-- Inventario -->
    <div id="inventario" class="tabcontent active">
        <div class="search-and-button">
            <input type="text" id="searchInventario" class="search-bar" placeholder="Buscar por ID Llanta..." oninput="searchInventario()">
            <button class="primary" onclick="fetchInventario()">Actualizar inventario</button>
        </div>
        <table id="tablaInventario">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Descripción</th>
                    <th>Peso (kg)</th>
                    <th>Volumen (m³)</th>
                    <th>Valor ($)</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Flota -->
    <div id="flota" class="tabcontent">
        <div class="search-and-button">
            <input type="text" id="searchFlota" class="search-bar" placeholder="Buscar por Número Económico..." oninput="searchFlota()">
            <button class="primary" onclick="fetchFlota()">Actualizar flota</button>
        </div>
        <table id="tablaFlota">
            <thead>
                <tr>
                    <th>Económico</th>
                    <th>Unidad</th>
                    <th>Asignado</th>
                    <th>Modelo</th>
                    <th>Placas</th>
                    <th>Ubicación</th>
                    <th>Carga (kg)</th>
                    <th>Volumen (m³)</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Pedidos -->
    <div id="pedidos" class="tabcontent" style="max-width: 1000px;">
        <div>
            <label for="inputPedidoNumEconomico">Número Económico Camión:</label>
            <input type="text" id="inputPedidoNumEconomico" oninput="llenarDatosCamionPedido()" placeholder="Ingrese número económico" />
        </div>
        <div id="datosCamionPedido" style="margin-top:10px; font-weight:bold; min-height: 50px;"></div>

        <div style="margin-top: 20px;">
            <div class="graph-container">
                <canvas id="graphVolumen" width="400" height="250"></canvas>
                <p style="text-align:center">Volumen Usado</p>
            </div>
            <div class="graph-container">
                <canvas id="graphCarga" width="400" height="250"></canvas>
                <p style="text-align:center">Carga Usada</p>
            </div>
        </div>

        <h3>Agregar Llanta al Pedido</h3>
        <table id="tablaPedidoAgregar" style="max-width:700px;">
            <thead>
                <tr>
                    <th>Código Llanta</th>
                    <th>Descripción</th>
                    <th>Cantidad</th>
                    <th>Peso</th>
                    <th>Volumen</th>
                    <th>Valor Unitario ($)</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><input type="text" id="pedidoCodigoLlanta" oninput="autoCompletarLlantaPedido()" /></td>
                    <td id="pedidoDescripcionLlanta"></td>
                    <td><input type="number" id="pedidoCantidadLlanta" value="1" min="1" oninput="calcularTotalesPedido()" /></td>
                    <td id="pedidoPesoLlanta">0</td>
                    <td id="pedidoVolumenLlanta">0</td>
                    <td id="pedidoValorUnitarioLlanta">0</td>
                    <td><button class="primary" onclick="agregarPedido()">Agregar</button></td>
                </tr>
            </tbody>
        </table>

        <h3>Pedidos actuales del camión</h3>
        <table id="tablaPedidosActuales" style="max-width:700px;">
            <thead>
                <tr>
                    <th>Código</th>
                    <th>Descripción</th>
                    <th>Cantidad</th>
                    <th>Volumen Total</th>
                    <th>Peso Total</th>
                    <th>Valor Total ($)</th>
                    <th>Quitar</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div style="margin-top: 10px; font-weight: bold;">
            <span id="totalesPedido"></span>
        </div>

        <button class="primary" onclick="aceptarPedido()" style="margin-top: 10px;">Aceptar Pedido</button>
    </div>

    <!-- Pedidos Confirmados -->
    <div id="pedidos-confirmados" class="tabcontent" style="max-width: 900px;">
        <h3>Pedidos Confirmados</h3>
        <table id="tablaPedidosConfirmados">
            <thead>
                <tr>
                    <th>Camión</th>
                    <th>Llantas</th>
                    <th>Volumen</th>
                    <th>Peso</th>
                    <th>Valor ($)</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Variables de datos
let inventario = [];
let flota = [];
let pedidosConfirmados = [];
let pedidosEnCurso = [];
let pedidoCamion = null;

// --- Cargar datos desde SheetDB al iniciar ---
async function fetchInventario() {
    try {
        const res = await fetch('https://sheetdb.io/api/v1/4aulf90lndqis');
        if (!res.ok) throw new Error('Error al cargar inventario');
        inventario = await res.json();
        renderInventario();
    } catch(e) {
        alert('No se pudo cargar el inventario: ' + e.message);
    }
}
async function fetchFlota() {
    try {
        const res = await fetch('https://sheetdb.io/api/v1/4aulf90lndqis?sheet=flota');
        if (!res.ok) throw new Error('Error al cargar flota');
        flota = await res.json();
        renderFlota();
    } catch(e) {
        alert('No se pudo cargar la flota: ' + e.message);
    }
}
fetchInventario();
fetchFlota();

// Cambiar pestañas
const tablinks = document.querySelectorAll('.tablink');
const tabcontents = document.querySelectorAll('.tabcontent');
tablinks.forEach(button => {
    button.addEventListener('click', () => {
        tablinks.forEach(btn => btn.classList.remove('active'));
        tabcontents.forEach(tc => tc.classList.remove('active'));
        button.classList.add('active');
        document.getElementById(button.dataset.tab).classList.add('active');
        if(button.dataset.tab === 'inventario') renderInventario();
        if(button.dataset.tab === 'flota') renderFlota();
        if(button.dataset.tab === 'pedidos') resetPedidoInputs();
        if(button.dataset.tab === 'pedidos-confirmados') renderPedidosConfirmados();
    });
});

// Render Inventario
function renderInventario() {
    const tbody = document.querySelector('#tablaInventario tbody');
    tbody.innerHTML = '';
    inventario.forEach(llanta => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${llanta.id}</td>
            <td>${llanta.descripcion}</td>
            <td>${(+llanta.peso).toFixed(2)}</td>
            <td>${(+llanta.volumen).toFixed(4)}</td>
            <td>$${(+llanta.valor).toFixed(2)}</td>`;
        tbody.appendChild(tr);
    });
    highlightSearch('inventario', document.getElementById('searchInventario').value);
}
// Buscar ID inventario
function searchInventario() {
    const filter = document.getElementById('searchInventario').value.toLowerCase();
    const tbody = document.querySelector('#tablaInventario tbody');
    for(let row of tbody.rows) {
        const idCell = row.cells[0].textContent.toLowerCase();
        row.style.display = idCell.includes(filter) ? '' : 'none';
        if(idCell.includes(filter) && filter) {
            row.classList.add('highlight-yellow');
            setTimeout(() => row.classList.remove('highlight-yellow'), 1100);
        }
    }
}
function highlightSearch(tab, valor) {
    if (!valor) return;
    let rows = document.querySelector(`#tabla${tab.charAt(0).toUpperCase() + tab.slice(1)} tbody`).rows;
    [...rows].forEach(row => {
        if(row.cells[0].textContent.toLowerCase().includes(valor.toLowerCase())){
            row.classList.add('highlight-yellow');
            row.scrollIntoView({behavior:"smooth", block:"center"});
            setTimeout(()=>row.classList.remove('highlight-yellow'),900);
        }
    });
}

// Render Flota
function renderFlota() {
    const tbody = document.querySelector('#tablaFlota tbody');
    tbody.innerHTML = '';
    flota.forEach(camion => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${camion.economico}</td>
            <td>${camion.unidad}</td>
            <td>${camion.asignado}</td>
            <td>${camion.modelo}</td>
            <td>${camion.placas}</td>
            <td>${camion.ubicacion}</td>
            <td>${(+camion.carga).toFixed(2)}</td>
            <td>${(+camion.volumen).toFixed(4)}</td>`;
        tbody.appendChild(tr);
    });
    highlightSearch('flota', document.getElementById('searchFlota').value);
}
function searchFlota() {
    const filter = document.getElementById('searchFlota').value.toLowerCase();
    const tbody = document.querySelector('#tablaFlota tbody');
    for(let row of tbody.rows) {
        const idCell = row.cells[0].textContent.toLowerCase();
        row.style.display = idCell.includes(filter) ? '' : 'none';
        if(idCell.includes(filter) && filter) {
            row.classList.add('highlight-yellow');
            setTimeout(() => row.classList.remove('highlight-yellow'), 1100);
        }
    }
}

// Pedido: buscador de camión/llenado automático de datos
function llenarDatosCamionPedido() {
    const numEco = document.getElementById('inputPedidoNumEconomico').value.trim();
    const div = document.getElementById('datosCamionPedido');
    pedidoCamion = flota.find(c => c.economico.toString() === numEco);
    if(pedidoCamion) {
        div.innerText = `Camión: ${pedidoCamion.unidad}, Asignado: ${pedidoCamion.asignado}, Modelo: ${pedidoCamion.modelo}, Capacidad carga: ${pedidoCamion.carga} kg, Cap. volumen: ${pedidoCamion.volumen} m³`;
        pedidosEnCurso = [];
        renderPedidosActuales();
        actualizarGraficas();
    } else {
        div.innerText = 'Camión no encontrado.';
        pedidosEnCurso = [];
        renderPedidosActuales();
        actualizarGraficas();
    }
}
function autoCompletarLlantaPedido() {
    const codigo = document.getElementById('pedidoCodigoLlanta').value.trim();
    const llanta = inventario.find(item => item.id.toString() === codigo);
    if(llanta) {
        document.getElementById('pedidoDescripcionLlanta').innerText = llanta.descripcion;
        document.getElementById('pedidoCantidadLlanta').value = 1;
        document.getElementById('pedidoPesoLlanta').innerText = (+llanta.peso).toFixed(2);
        document.getElementById('pedidoVolumenLlanta').innerText = (+llanta.volumen).toFixed(4);
        document.getElementById('pedidoValorUnitarioLlanta').innerText = (+llanta.valor).toFixed(2);
    } else {
        document.getElementById('pedidoDescripcionLlanta').innerText = '';
        document.getElementById('pedidoPesoLlanta').innerText = '0';
        document.getElementById('pedidoVolumenLlanta').innerText = '0';
        document.getElementById('pedidoValorUnitarioLlanta').innerText = '0';
    }
}
function calcularTotalesPedido() {
    const cantidad = Number(document.getElementById('pedidoCantidadLlanta').value);
    const codigo = document.getElementById('pedidoCodigoLlanta').value.trim();
    const llanta = inventario.find(item => item.id.toString() === codigo);
    if(llanta && cantidad > 0) {
        document.getElementById('pedidoPesoLlanta').innerText = (llanta.peso * cantidad).toFixed(2);
        document.getElementById('pedidoVolumenLlanta').innerText = (llanta.volumen * cantidad).toFixed(4);
        document.getElementById('pedidoValorUnitarioLlanta').innerText = (llanta.valor * cantidad).toFixed(2);
    }
}
function agregarPedido() {
    if(!pedidoCamion) {
        alert("Ingrese un número económico válido de camión primero.");
        return;
    }
    const codigo = document.getElementById('pedidoCodigoLlanta').value.trim();
    const cantidad = Number(document.getElementById('pedidoCantidadLlanta').value);
    if(cantidad <= 0) {
        alert("La cantidad debe ser mayor a 0.");
        return;
    }
    const llanta = inventario.find(item => item.id.toString() === codigo);
    if(!llanta) {
        alert("Llanta no encontrada en inventario.");
        return;
    }
    const pedidoExistente = pedidosEnCurso.find(p => p.id === llanta.id);
    if(pedidoExistente) {
        pedidoExistente.cantidad += cantidad;
        pedidoExistente.peso += (+llanta.peso * cantidad);
        pedidoExistente.volumen += (+llanta.volumen * cantidad);
        pedidoExistente.valor += (+llanta.valor * cantidad);
    } else {
        pedidosEnCurso.push({
            id: llanta.id,
            descripcion: llanta.descripcion,
            cantidad: cantidad,
            peso: (+llanta.peso) * cantidad,
            volumen: (+llanta.volumen) * cantidad,
            valor: (+llanta.valor) * cantidad
        });
    }
    renderPedidosActuales();
    actualizarGraficas();
    resetPedidoInputs();
}
function renderPedidosActuales() {
    const tbody = document.querySelector('#tablaPedidosActuales tbody');
    tbody.innerHTML = '';
    pedidosEnCurso.forEach((pedido, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${pedido.id}</td>
            <td>${pedido.descripcion}</td>
            <td>${pedido.cantidad}</td>
            <td>${pedido.volumen.toFixed(4)}</td>
            <td>${pedido.peso.toFixed(2)}</td>
            <td>$${pedido.valor.toFixed(2)}</td>
            <td><button onclick="quitarPedido(${idx})">Quitar</button></td>
        `;
        tbody.appendChild(tr);
    });
    // Totales
    let totalCantidad = 0, totalVolumen = 0, totalPeso = 0, totalValor = 0;
    pedidosEnCurso.forEach(p => {
        totalCantidad += p.cantidad;
        totalVolumen += p.volumen;
        totalPeso += p.peso;
        totalValor += p.valor;
    });
    document.getElementById('totalesPedido').innerText = `Total cantidad: ${totalCantidad} | Total volumen: ${totalVolumen.toFixed(4)} m³ | Total peso: ${totalPeso.toFixed(2)} kg | Total valor: $${totalValor.toFixed(2)}`;
    verificarCapacidad(totalVolumen, totalPeso);
}
function quitarPedido(idx) {
    pedidosEnCurso.splice(idx, 1);
    renderPedidosActuales();
    actualizarGraficas();
}
function resetPedidoInputs() {
    document.getElementById('pedidoCodigoLlanta').value = '';
    document.getElementById('pedidoDescripcionLlanta').innerText = '';
    document.getElementById('pedidoCantidadLlanta').value = 1;
    document.getElementById('pedidoPesoLlanta').innerText = '0';
    document.getElementById('pedidoVolumenLlanta').innerText = '0';
    document.getElementById('pedidoValorUnitarioLlanta').innerText = '0';
}
// ----- Gráficas -----
const ctxVolumen = document.getElementById('graphVolumen').getContext('2d');
const ctxCarga = document.getElementById('graphCarga').getContext('2d');
let chartVolumen = new Chart(ctxVolumen, {
    type: 'doughnut',
    data: { labels: ['Usado', 'Disponible'],
        datasets: [{ data: [0, 100], backgroundColor: ['#75c286', '#f3f3f3'], borderWidth: 1 }]
    },
    options: { plugins: {legend: {display: true}}, cutout: '70%' }
});
let chartCarga = new Chart(ctxCarga, {
    type: 'doughnut',
    data: { labels: ['Usado', 'Disponible'],
        datasets: [{ data: [0, 100], backgroundColor: ['#7ad4a2', '#f3f3f3'], borderWidth: 1 }]
    },
    options: { plugins: {legend: {display: true}}, cutout: '70%' }
});
function actualizarGraficas() {
    if(!pedidoCamion) {
        chartVolumen.data.datasets[0].data = [0, 100];
        chartCarga.data.datasets[0].data = [0, 100];
    } else {
        let totalVolumen = pedidosEnCurso.reduce((acc, cur) => acc + cur.volumen, 0);
        let totalPeso = pedidosEnCurso.reduce((acc, cur) => acc + cur.peso, 0);
        let volTotal = +pedidoCamion.volumen;
        let pesoTotal = +pedidoCamion.carga;
        chartVolumen.data.datasets[0].data = [Math.min(totalVolumen,volTotal), Math.max(0, volTotal-totalVolumen)];
        chartCarga.data.datasets[0].data = [Math.min(totalPeso,pesoTotal), Math.max(0, pesoTotal-totalPeso)];
    }
    chartVolumen.update(); chartCarga.update();
}
function verificarCapacidad(volumen, peso) {
    if(!pedidoCamion) return;
    const capVol = +pedidoCamion.volumen;
    const capPes = +pedidoCamion.carga;
    const volumenPercent = (volumen/capVol)*100, pesoPercent = (peso/capPes)*100;
    if(volumenPercent > 80 || pesoPercent > 80) {
        if(confirm('El camión se está llenando (>80%), ¿desea completar con otro camión?')) {
            alert('Aquí puedes permitir solicitar otro camión para continuar cargando los pedidos.');
        }
    }
}
function aceptarPedido() {
    if(!pedidoCamion) { alert('Debe seleccionar un camión válido para aceptar el pedido.'); return;}
    if(pedidosEnCurso.length === 0) { alert('El pedido está vacío.'); return; }
    let totalVolumen = pedidosEnCurso.reduce((acc, cur) => acc + cur.volumen, 0);
    let totalPeso = pedidosEnCurso.reduce((acc, cur) => acc + cur.peso, 0);
    let totalValor = pedidosEnCurso.reduce((acc, cur) => acc + cur.valor, 0);
    pedidosConfirmados.push({
        camion: pedidoCamion.economico,
        llantas: pedidosEnCurso.map(p => p.id).join(', '),
        volumen: totalVolumen,
        peso: totalPeso,
        valor: totalValor
    });
    pedidosEnCurso = [];
    pedidoCamion = null;
    document.getElementById('datosCamionPedido').innerText = '';
    document.getElementById('inputPedidoNumEconomico').value = '';
    renderPedidosActuales();
    actualizarGraficas();
    alert('Pedido aceptado y movido a pedidos confirmados.');
    renderPedidosConfirmados();
}
// -- Lista de pedidos confirmados --
function renderPedidosConfirmados() {
    const tbody = document.querySelector('#tablaPedidosConfirmados tbody');
    tbody.innerHTML = '';
    pedidosConfirmados.forEach((pedido, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${pedido.camion}</td>
            <td>${pedido.llantas}</td>
            <td>${pedido.volumen.toFixed(4)}</td>
            <td>${pedido.peso.toFixed(2)}</td>
            <td>$${pedido.valor.toFixed(2)}</td>
            <td><button onclick="cancelarPedido(${idx})">Cancelar</button></td>`;
        tbody.appendChild(tr);
    });
}
function cancelarPedido(idx) {
    if(confirm('¿Seguro que desea cancelar este pedido?')) {
        pedidosConfirmados.splice(idx, 1);
        renderPedidosConfirmados();
    }
}
</script>
</body>
</html>
